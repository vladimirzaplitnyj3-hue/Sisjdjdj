#!/usr/bin/env python3
"""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë      RETSING BOT - –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô  ‚ïë
‚ïë        –¢–ï–õ–ï–ì–†–ê–ú –ë–û–¢ –î–õ–Ø –†–ê–°–°–´–õ–ö–ò     ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
–í–µ—Ä—Å–∏—è: 3.0 | –°–æ–∑–¥–∞—Ç–µ–ª—å: 7370566881
"""

import asyncio
import logging
import sys
from datetime import datetime, timedelta
from typing import Dict, List, Set
import aiohttp
from pyrogram import Client, filters, idle
from pyrogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton
from pyrogram.enums import ParseMode
from pyrogram.errors import (
    SessionPasswordNeeded, PhoneCodeInvalid, 
    FloodWait, PeerIdInvalid, ChannelInvalid
)
import colorama
from colorama import Fore, Style

# ================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ==================
colorama.init(autoreset=True)

API_ID = 23258474
API_HASH = "f5dd3f52675030a650ca2259f9fb79ce"
BOT_TOKEN = "8379847495:AAHQIC5D9fipWz76h3-y0UOsY3amN5RUD_U"
CREATOR_ID = 7370566881
BOT_NAME = "RETSING BOT"
BOT_LINK = "@RETSINGBOT"

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
mailing_data = {
    "active": False,
    "text": "",
    "chats": [],
    "start_time": None,
    "sent_count": 0,
    "failed_count": 0,
    "current_cycle": 0
}

# ================== –ù–ê–°–¢–†–û–ô–ö–ê –õ–û–ì–ò–†–û–í–ê–ù–ò–Ø ==================
def setup_logging():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫—Ä–∞—Å–∏–≤–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è"""
    logging.basicConfig(
        level=logging.INFO,
        format=f'{Fore.CYAN}%(asctime)s{Style.RESET_ALL} - '
               f'{Fore.GREEN}%(name)s{Style.RESET_ALL} - '
               f'{Fore.YELLOW}%(levelname)s{Style.RESET_ALL} - '
               f'{Fore.WHITE}%(message)s{Style.RESET_ALL}',
        handlers=[
            logging.StreamHandler(),
            logging.FileHandler('retsing_bot.log', encoding='utf-8')
        ]
    )
    return logging.getLogger(__name__)

logger = setup_logging()

# ================== –ö–õ–ê–°–° –ë–û–¢–ê ==================
class RetsingBot:
    def __init__(self):
        self.client = None
        self.session_name = "retsing_account"
        self.is_authenticated = False
        self.mailing_task = None
        
    async def start(self):
        """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞"""
        print(f"\n{Fore.MAGENTA}{'='*50}")
        print(f"{Fore.YELLOW}üöÄ –ó–ê–ü–£–°–ö {BOT_NAME}")
        print(f"{Fore.MAGENTA}{'='*50}{Style.RESET_ALL}\n")
        
        # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
        await self.notify_admin("üü¢ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
        
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞
        self.client = Client(
            self.session_name,
            api_id=API_ID,
            api_hash=API_HASH,
            device_model="Retsing Pro",
            app_version="3.0.0",
            system_version="Retsing OS 1.0"
        )
        
        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
        self.register_handlers()
        
        # –ó–∞–ø—É—Å–∫
        await self.client.start()
        self.is_authenticated = True
        
        logger.info(f"{Fore.GREEN}‚úÖ –ë–æ—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫: {self.client.me.first_name}")
        
        # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π idle
        await idle()
        
    async def stop(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞"""
        if self.mailing_task:
            self.mailing_task.cancel()
        
        if self.client:
            await self.client.stop()
        
        await self.notify_admin("üî¥ –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
        logger.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")
    
    async def notify_admin(self, message: str):
        """–û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É"""
        try:
            if self.client and self.is_authenticated:
                await self.client.send_message(
                    CREATOR_ID,
                    f"üì¢ **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç {BOT_NAME}**\n\n{message}",
                    parse_mode=ParseMode.MARKDOWN
                )
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")
    
    def register_handlers(self):
        """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥"""
        
        @self.client.on_message(filters.command("start") & filters.private)
        async def start_command(client: Client, message: Message):
            """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
            if message.from_user.id != CREATOR_ID:
                await message.reply_text(
                    "‚õî **–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!**\n"
                    "–≠—Ç–æ—Ç –±–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–∑–¥–∞—Ç–µ–ª—è.",
                    parse_mode=ParseMode.MARKDOWN
                )
                return
            
            welcome_text = f"""
üåü **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ {BOT_NAME}!** üåü

‚ö° **–ú–æ—â–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–∞—Å—Å—ã–ª–∫–∏**
üÜì **–ü–æ–ª–Ω–æ—Å—Ç—å—é –±–µ—Å–ø–ª–∞—Ç–Ω–æ!**

üìã **–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**
‚ñ´Ô∏è `/help` - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
‚ñ´Ô∏è `/setup` - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
‚ñ´Ô∏è `/launch` - –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
‚ñ´Ô∏è `/stats` - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
‚ñ´Ô∏è `/stop` - –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É

üöÄ **–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:**
1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/setup` –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ä–∞—Å—Å—ã–ª–∫—É `/launch`
3. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ `/stop`

üí° **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã
‚Ä¢ –ü–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
‚Ä¢ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ 24/7
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —á–∞—Ç–æ–≤

üìû **–ü–æ–¥–¥–µ—Ä–∂–∫–∞:** {BOT_LINK}
            """
            
            keyboard = InlineKeyboardMarkup([
                [InlineKeyboardButton("üöÄ –ù–∞—á–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É", callback_data="setup")],
                [InlineKeyboardButton("üìä –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ–º–æ", callback_data="demo")],
                [InlineKeyboardButton("üë®‚Äçüíª –ü–æ–¥–¥–µ—Ä–∂–∫–∞", url=f"https://t.me/{BOT_LINK[1:]}")]
            ])
            
            await message.reply_text(
                welcome_text,
                reply_markup=keyboard,
                parse_mode=ParseMode.MARKDOWN
            )
            logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –≤—ã–∑–≤–∞–ª /start")
        
        @self.client.on_message(filters.command("setup") & filters.private)
        async def setup_command(client: Client, message: Message):
            """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏"""
            if message.from_user.id != CREATOR_ID:
                return
            
            await message.reply_text(
                "üõ† **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏**\n\n"
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏.\n"
                "–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ç–∫—É Markdown.",
                parse_mode=ParseMode.MARKDOWN
            )
        
        @self.client.on_message(filters.command("launch") & filters.private)
        async def launch_command(client: Client, message: Message):
            """–ó–∞–ø—É—Å–∫ —Ä–∞—Å—Å—ã–ª–∫–∏"""
            if message.from_user.id != CREATOR_ID:
                return
            
            if mailing_data["active"]:
                await message.reply_text(
                    "‚ö†Ô∏è **–†–∞—Å—Å—ã–ª–∫–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞!**\n"
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/stop` –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.",
                    parse_mode=ParseMode.MARKDOWN
                )
                return
            
            if not mailing_data["text"]:
                await message.reply_text(
                    "‚ùå **–°–Ω–∞—á–∞–ª–∞ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ —Ä–∞—Å—Å—ã–ª–∫—É!**\n"
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/setup` –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞ –∏ —á–∞—Ç–æ–≤.",
                    parse_mode=ParseMode.MARKDOWN
                )
                return
            
            if not mailing_data["chats"]:
                await message.reply_text(
                    "‚ùå **–ù–µ —É–∫–∞–∑–∞–Ω—ã —á–∞—Ç—ã –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏!**\n"
                    "–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —á–∞—Ç —Å –ø–æ–º–æ—â—å—é /setup",
                    parse_mode=ParseMode.MARKDOWN
                )
                return
            
            # –ó–∞–ø—É—Å–∫ —Ä–∞—Å—Å—ã–ª–∫–∏
            mailing_data["active"] = True
            mailing_data["start_time"] = datetime.now()
            mailing_data["sent_count"] = 0
            mailing_data["failed_count"] = 0
            mailing_data["current_cycle"] = 0
            
            self.mailing_task = asyncio.create_task(self.start_mailing())
            
            await message.reply_text(
                f"üöÄ **–†–ê–°–°–´–õ–ö–ê –ó–ê–ü–£–©–ï–ù–ê!**\n\n"
                f"‚Ä¢ **–¢–µ–∫—Å—Ç:** {mailing_data['text'][:50]}...\n"
                f"‚Ä¢ **–ß–∞—Ç–æ–≤:** {len(mailing_data['chats'])}\n"
                f"‚Ä¢ **–ò–Ω—Ç–µ—Ä–≤–∞–ª:** 2 –º–∏–Ω—É—Ç—ã\n"
                f"‚Ä¢ **–°—Ç–∞—Ä—Ç:** {mailing_data['start_time'].strftime('%H:%M:%S')}\n\n"
                f"üìä –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/stats` –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
                parse_mode=ParseMode.MARKDOWN
            )
            
            await self.notify_admin("üöÄ –†–∞—Å—Å—ã–ª–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω–∞!")
            logger.info(f"–†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–ø—É—â–µ–Ω–∞ –¥–ª—è {len(mailing_data['chats'])} —á–∞—Ç–æ–≤")
        
        @self.client.on_message(filters.command("stop") & filters.private)
        async def stop_command(client: Client, message: Message):
            """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏"""
            if message.from_user.id != CREATOR_ID:
                return
            
            if not mailing_data["active"]:
                await message.reply_text(
                    "‚ÑπÔ∏è **–†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞**",
                    parse_mode=ParseMode.MARKDOWN
                )
                return
            
            mailing_data["active"] = False
            
            if self.mailing_task:
                self.mailing_task.cancel()
            
            elapsed = datetime.now() - mailing_data["start_time"]
            
            await message.reply_text(
                f"üõë **–†–ê–°–°–´–õ–ö–ê –û–°–¢–ê–ù–û–í–õ–ï–ù–ê!**\n\n"
                f"üìä **–ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**\n"
                f"‚Ä¢ –£—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {mailing_data['sent_count']}\n"
                f"‚Ä¢ –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: {mailing_data['failed_count']}\n"
                f"‚Ä¢ –¶–∏–∫–ª–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: {mailing_data['current_cycle']}\n"
                f"‚Ä¢ –û–±—â–µ–µ –≤—Ä–µ–º—è: {str(elapsed).split('.')[0]}\n"
                f"‚Ä¢ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: {mailing_data['sent_count'] / max(elapsed.total_seconds() / 60, 1):.1f} —Å–æ–æ–±—â./–º–∏–Ω",
                parse_mode=ParseMode.MARKDOWN
            )
            
            await self.notify_admin("üõë –†–∞—Å—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
            logger.info("–†–∞—Å—Å—ã–ª–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
        
        @self.client.on_message(filters.command("stats") & filters.private)
        async def stats_command(client: Client, message: Message):
            """–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"""
            if message.from_user.id != CREATOR_ID:
                return
            
            if not mailing_data["active"]:
                await message.reply_text(
                    "‚ÑπÔ∏è **–†–∞—Å—Å—ã–ª–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞**\n"
                    "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/launch` –¥–ª—è –∑–∞–ø—É—Å–∫–∞",
                    parse_mode=ParseMode.MARKDOWN
                )
                return
            
            elapsed = datetime.now() - mailing_data["start_time"]
            
            stats_text = f"""
üìä **–°–¢–ê–¢–ò–°–¢–ò–ö–ê –†–ê–°–°–´–õ–ö–ò**

üü¢ **–°–æ—Å—Ç–æ—è–Ω–∏–µ:** –ê–∫—Ç–∏–≤–Ω–∞
‚è± **–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:** {str(elapsed).split('.')[0]}
üîÑ **–¶–∏–∫–ª:** #{mailing_data['current_cycle'] + 1}

‚úÖ **–£—Å–ø–µ—à–Ω–æ:** {mailing_data['sent_count']} —Å–æ–æ–±—â–µ–Ω–∏–π
‚ùå **–û—à–∏–±–æ–∫:** {mailing_data['failed_count']}
üìà **–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:** {mailing_data['sent_count'] / max(mailing_data['sent_count'] + mailing_data['failed_count'], 1) * 100:.1f}%

üë• **–ß–∞—Ç—ã:** {len(mailing_data['chats'])} —à—Ç.
‚è≥ **–°–ª–µ–¥—É—é—â–∏–π —Ü–∏–∫–ª:** —á–µ—Ä–µ–∑ {120 - (elapsed.total_seconds() % 120):.0f} —Å–µ–∫.

üöÄ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** {mailing_data['sent_count'] / max(elapsed.total_seconds() / 60, 1):.1f} —Å–æ–æ–±—â./–º–∏–Ω
            """
            
            await message.reply_text(stats_text, parse_mode=ParseMode.MARKDOWN)
        
        @self.client.on_message(filters.text & filters.private)
        async def handle_text(client: Client, message: Message):
            """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
            if message.from_user.id != CREATOR_ID:
                return
            
            # –ï—Å–ª–∏ —ç—Ç–æ –æ—Ç–≤–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å —Ç–µ–∫—Å—Ç–∞ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
            if not message.text.startswith('/'):
                # –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏
                mailing_data["text"] = message.text
                
                # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å
                full_text = f"{message.text}\n\n{'‚îÅ' * 30}\nüì® **–°–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–º –±–æ—Ç–æ–º –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏ [{BOT_NAME}](https://t.me/{BOT_LINK[1:]})**"
                mailing_data["text"] = full_text
                
                # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —á–∞—Ç—ã
                await message.reply_text(
                    f"‚úÖ **–¢–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω!**\n\n"
                    f"üìù **–î–ª–∏–Ω–∞:** {len(full_text)} —Å–∏–º–≤–æ–ª–æ–≤\n\n"
                    f"–¢–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤—å—Ç–µ ID —á–∞—Ç–æ–≤ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏.\n"
                    f"**–§–æ—Ä–º–∞—Ç:** `-1001234567890, -1009876543210`\n\n"
                    f"üí° **–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å ID —á–∞—Ç–∞:**\n"
                    f"1. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ —á–∞—Ç\n"
                    f"2. –°–¥–µ–ª–∞–π—Ç–µ –µ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º\n"
                    f"3. ID –ø–æ—è–≤–∏—Ç—Å—è –≤ –ª–æ–≥–∞—Ö",
                    parse_mode=ParseMode.MARKDOWN
                )
            
            # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç ID —á–∞—Ç–æ–≤
            elif all(c.isdigit() or c in '- ,' for c in message.text.replace(' ', '')):
                try:
                    chats = [int(chat_id.strip()) for chat_id in message.text.split(',')]
                    mailing_data["chats"] = chats
                    
                    await message.reply_text(
                        f"‚úÖ **–ß–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!**\n\n"
                        f"üë• **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:** {len(chats)} —á–∞—Ç–æ–≤\n"
                        f"üìù **–¢–µ–∫—Å—Ç:** {mailing_data['text'][:50]}...\n\n"
                        f"üöÄ **–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É!**\n"
                        f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/launch` –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—ã–ª–∫–∏",
                        parse_mode=ParseMode.MARKDOWN
                    )
                except ValueError:
                    await message.reply_text(
                        "‚ùå **–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç ID!**\n\n"
                        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç:\n"
                        "`-1001234567890, -1009876543210`",
                        parse_mode=ParseMode.MARKDOWN
                    )
        
        @self.client.on_callback_query()
        async def handle_callback(client: Client, callback_query):
            """–û–±—Ä–∞–±–æ—Ç–∫–∞ callback-–∑–∞–ø—Ä–æ—Å–æ–≤"""
            if callback_query.from_user.id != CREATOR_ID:
                await callback_query.answer("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω!", show_alert=True)
                return
            
            if callback_query.data == "setup":
                await callback_query.message.edit_text(
                    "üõ† **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏**\n\n"
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏.\n"
                    "–í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–º–µ—Ç–∫—É Markdown.",
                    parse_mode=ParseMode.MARKDOWN
                )
            
            elif callback_query.data == "demo":
                await callback_query.message.edit_text(
                    f"üé¨ **–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã {BOT_NAME}**\n\n"
                    f"1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞** - `/setup`\n"
                    f"2. **–ó–∞–ø—É—Å–∫** - `/launch`\n"
                    f"3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - `/stats`\n"
                    f"4. **–û—Å—Ç–∞–Ω–æ–≤–∫–∞** - `/stop`\n\n"
                    f"‚ö° **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**\n"
                    f"‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞–∂–¥—ã–µ 2 –º–∏–Ω—É—Ç—ã\n"
                    f"‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏\n"
                    f"‚Ä¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É\n"
                    f"‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Markdown\n\n"
                    f"üíé **–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å!**",
                    parse_mode=ParseMode.MARKDOWN
                )
            
            await callback_query.answer()
    
    async def start_mailing(self):
        """–ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ —Ä–∞—Å—Å—ã–ª–∫–∏"""
        logger.info("–ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞ —Ä–∞—Å—Å—ã–ª–∫–∏...")
        
        while mailing_data["active"]:
            cycle_sent = 0
            cycle_failed = 0
            
            logger.info(f"–ù–∞—á–∞–ª–æ —Ü–∏–∫–ª–∞ #{mailing_data['current_cycle'] + 1}")
            
            for chat_id in mailing_data["chats"]:
                if not mailing_data["active"]:
                    break
                
                try:
                    await self.client.send_message(
                        chat_id,
                        mailing_data["text"],
                        parse_mode=ParseMode.MARKDOWN
                    )
                    cycle_sent += 1
                    mailing_data["sent_count"] += 1
                    
                    # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
                    await asyncio.sleep(0.5)
                    
                except FloodWait as e:
                    logger.warning(f"FloodWait –Ω–∞ {e.value} —Å–µ–∫—É–Ω–¥ –¥–ª—è —á–∞—Ç–∞ {chat_id}")
                    await asyncio.sleep(e.value)
                    continue
                except (PeerIdInvalid, ChannelInvalid):
                    logger.error(f"–ù–µ–≤–µ—Ä–Ω—ã–π ID —á–∞—Ç–∞: {chat_id}")
                    cycle_failed += 1
                    mailing_data["failed_count"] += 1
                except Exception as e:
                    logger.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ {chat_id}: {e}")
                    cycle_failed += 1
                    mailing_data["failed_count"] += 1
            
            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ü–∏–∫–ª–∞
            mailing_data["current_cycle"] += 1
            
            # –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
            if mailing_data["active"]:
                elapsed = datetime.now() - mailing_data["start_time"]
                
                stats_msg = (
                    f"üìä **–¶–∏–∫–ª #{mailing_data['current_cycle']} –∑–∞–≤–µ—Ä—à–µ–Ω**\n\n"
                    f"‚úÖ **–£—Å–ø–µ—à–Ω–æ:** {cycle_sent}\n"
                    f"‚ùå **–û—à–∏–±–æ–∫:** {cycle_failed}\n"
                    f"üîÑ **–í—Å–µ–≥–æ —Ü–∏–∫–ª–æ–≤:** {mailing_data['current_cycle']}\n"
                    f"üìà **–í—Å–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:** {mailing_data['sent_count']}\n"
                    f"‚è± **–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:** {str(elapsed).split('.')[0]}\n\n"
                    f"‚è≥ **–°–ª–µ–¥—É—é—â–∏–π —Ü–∏–∫–ª —á–µ—Ä–µ–∑ 2 –º–∏–Ω—É—Ç—ã**"
                )
                
                try:
                    await self.client.send_message(
                        CREATOR_ID,
                        stats_msg,
                        parse_mode=ParseMode.MARKDOWN
                    )
                except:
                    pass
                
                # –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —Ü–∏–∫–ª–æ–º
                for i in range(120):  # 120 —Å–µ–∫—É–Ω–¥ = 2 –º–∏–Ω—É—Ç—ã
                    if not mailing_data["active"]:
                        break
                    await asyncio.sleep(1)
        
        logger.info("–¶–∏–∫–ª —Ä–∞—Å—Å—ã–ª–∫–∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

# ================== –ì–†–ê–§–ò–ß–ï–°–ö–ò–ô –ó–ê–ü–£–°–ö ==================
def print_banner():
    """–ü–µ—á–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ–≥–æ –±–∞–Ω–Ω–µ—Ä–∞"""
    banner = f"""
{Fore.MAGENTA}{'‚ñà'*60}
{Fore.CYAN}{' '*10}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
{Fore.CYAN}{' '*10}‚ïë          {Fore.YELLOW}RETSING BOT v3.0{Fore.CYAN}                   ‚ïë
{Fore.CYAN}{' '*10}‚ïë    {Fore.GREEN}–ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –ë–û–¢ –î–õ–Ø –†–ê–°–°–´–õ–û–ö{Fore.CYAN}     ‚ïë
{Fore.CYAN}{' '*10}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
{Fore.MAGENTA}{'‚ñà'*60}

{Fore.WHITE}üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
{Fore.CYAN}‚îú‚îÄ‚îÄ API ID: {Fore.YELLOW}{API_ID}
{Fore.CYAN}‚îú‚îÄ‚îÄ –°–æ–∑–¥–∞—Ç–µ–ª—å: {Fore.YELLOW}{CREATOR_ID}
{Fore.CYAN}‚îú‚îÄ‚îÄ –ò–º—è –±–æ—Ç–∞: {Fore.YELLOW}{BOT_NAME}
{Fore.CYAN}‚îî‚îÄ‚îÄ –°—Å—ã–ª–∫–∞: {Fore.YELLOW}{BOT_LINK}

{Fore.GREEN}‚úÖ –°—Ç–∞—Ç—É—Å: {Fore.YELLOW}–ó–∞–ø—É—Å–∫...
{Fore.CYAN}üìä –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤: {Fore.YELLOW}retsing_bot.log
{Fore.CYAN}üöÄ –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –Ω–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É: {Fore.YELLOW}/start

{Fore.MAGENTA}{'‚îÅ'*60}{Style.RESET_ALL}
    """
    print(banner)

# ================== –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ==================
async def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print_banner()
    
    bot = RetsingBot()
    
    try:
        await bot.start()
    except KeyboardInterrupt:
        logger.info("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (Ctrl+C)")
    except Exception as e:
        logger.error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
    finally:
        await bot.stop()

# ================== –ó–ê–ü–£–°–ö ==================
if __name__ == "__main__":
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Python
    if sys.version_info < (3, 7):
        print(f"{Fore.RED}‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è Python 3.7 –∏–ª–∏ –≤—ã—à–µ!")
        sys.exit(1)
    
    try:
        # –ó–∞–ø—É—Å–∫ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞
        asyncio.run(main())
    except KeyboardInterrupt:
        print(f"\n{Fore.YELLOW}üëã –ë–æ—Ç –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É")
        sys.exit(1)
